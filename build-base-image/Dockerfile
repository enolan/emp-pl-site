# Build a Docker image with the dependencies in it, to speed up Travis builds.
FROM fpco/stack-build:lts-8.0

RUN curl -L https://github.com/fpco/stack-docker-image-build/releases/download/v0.1.2.0/stack-docker-image-build > /usr/local/bin/stack-docker-image-build && chmod +x /usr/local/bin/stack-docker-image-build

# Separating the adding stack.yaml, running stack setup and building the deps
# steps make Docker's caching work better.
ADD ./stack.yaml /home/_stack/src/

RUN cd /home/_stack/src && stack setup --system-ghc

# the deps file is generated by:
# stack list-dependencies --separator - --no-include-base --test | tr '\n' ' ' > build-base-image/deps
# and then manually edited to remove version numbers from local packages.

ADD ./deps /home/_stack/src/

RUN rm /usr/local/bin/alex /usr/local/bin/happy &&\
    cd /home/_stack/src &&\
    /usr/local/bin/stack-docker-image-build $(cat deps) &&\
    chmod -R a+rX /root/